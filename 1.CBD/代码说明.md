# CBD 噪声采样器设计说明

## 模块概览

本目录包含用于 Kyber 等后量子密码算法的中心二项分布（CBD）采样器的硬件实现。设计通过参数化的 Verilog 模块实现，支持流水线与多通道并行采样，能够与 SHAKE 等伪随机数发生器生成的随机字节流协同工作。

主要文件：

- `cbd_sampler.v`：顶层 CBD 采样器，负责并行管理多个采样通道、与外部控制逻辑交互。
- `cbd_lane.v`：单通道采样核心，实现 CBD 候选值生成、Bernoulli 判决以及拒绝采样。
- `bernoulli_sampler.v`：纯组合的 Bernoulli 判决单元，通过阈值比较生成随机符号。
- `rejection_filter.v`：拒绝采样单元，根据候选值幅度动态调整接受概率。
- `test/cbd_sampler_tb.v`：针对顶层模块的 testbench，驱动随机向量并记录硬件输出。
- `test/cbd_golden.py`：Python 黄金模型，用于生成激励向量、计算期望结果并验证硬件输出，同时给出基础统计检验数据。

## 接口定义

### 顶层 `cbd_sampler`

| 端口 | 方向 | 宽度 | 描述 |
| ---- | ---- | ---- | ---- |
| `clk` | 输入 | 1 | 时钟信号 |
| `reset` | 输入 | 1 | 同步复位，高电平有效 |
| `start` | 输入 | 1 | 触发一次采样操作，在 `valid_in` 有效时加载随机向量 |
| `valid_in` | 输入 | 1 | 随机数据有效指示 |
| `random_in` | 输入 | `RAND_WIDTH` | 来自 SHAKE/PRNG 的随机字节流 |
| `threshold` | 输入 | `BERN_WIDTH` | Bernoulli 采样阈值 |
| `sampled_vals` | 输出 | `LANES*CAND_BITS` | 合并后的 CBD 采样结果，按通道低位打包 |
| `accepted_flags` | 输出 | `LANES` | 各通道拒绝采样接受标志 |
| `done` | 输出 | 1 | 所有通道输出有效时置位 |

### 通道 `cbd_lane`

- 内部通过 `ETA` 个随机比特计算 `sum_a`、`sum_b` 的汉明重量，二者差值即 CBD 候选值。
- `bernoulli_sampler` 利用 `threshold` 判定符号，输出值在两拍流水线后稳定。
- `rejection_filter` 使用候选幅度调节接受窗口，实现幅度越大被拒绝概率越高的策略。

## 流水线与并行化

- 顶层对随机数据进行锁存后，`cbd_lane` 在第一拍完成候选值、符号与接受概率的组合计算；第二拍将结果寄存后输出，满足 150 MHz 以上的时序目标。
- 通过 `LANES` 参数设置并行通道数量，当前 testbench 采用 4 通道并行，提升吞吐量。

## 测试与验证流程

1. 运行黄金模型生成激励：
   ```bash
   python3 test/cbd_golden.py --generate --vectors 128 --seed 2024
   ```
2. 使用 iverilog 进行仿真并输出硬件结果：
   ```bash
   iverilog -g2012 -I .. -o cbd_sampler_tb.vvp test/cbd_sampler_tb.v \
       ../cbd_sampler.v ../cbd_lane.v ../bernoulli_sampler.v ../rejection_filter.v
   vvp cbd_sampler_tb.vvp
   ```
   仿真结束后会在 `test/hw_output.txt` 中生成硬件输出。
3. 黄金模型验证硬件输出并给出统计检验：
   ```bash
   python3 test/cbd_golden.py --verify
   ```
   输出包括每个采样值的观测概率、理论概率以及卡方统计量、均值、方差等信息。

## 注意事项

- `RAND_WIDTH` 必须为 `LANES` 的整数倍，确保每个通道使用等宽随机向量。
- `CAND_BITS` 需大于等于 `log2(ETA+1)+1`，才能完整表示候选值。
- 拒绝采样窗口的基准值与移位因子在 `rejection_filter` 中可按需求调整，以适配不同算法参数。
- 当前设计使用两拍流水线，可根据综合结果进一步拆分或合并阶段以满足更高频率。

## 扩展建议

- 根据实际需求增加接口以支持一次加载多组随机数据，或在拒绝后自动重取随机向量。
- 将 `threshold` 扩展为 per-lane 配置，以适配更复杂的噪声调制策略。
- 结合 SHAKE 核心进行系统级联仿真，评估完整 Kyber 密钥生成/加密流程的时序与吞吐性能。
