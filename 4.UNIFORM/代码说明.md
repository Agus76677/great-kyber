# 均匀采样模块使用说明

## 模块概述
`uniform_sampler` 模块实现基于 Barrett 除法的均匀采样器。模块能够在一次时钟周期内吞吐 128 位随机数（默认配置），并行输出 `LANES` 个样本。每个样本在 `[0, q)` 范围内均匀分布，适用于后量子密码算法中对大吞吐量采样的需求。

模块内部采用三级流水线：
1. **阶段 0（输入寄存）**：锁存伪随机数输入与模数 `q`。
2. **阶段 1（辅助值计算）**：计算 Barrett 倒数 `mu = ⌊2^(CAND_BITS+Q_BITS)/q⌋` 与拒绝采样阈值因子 `floor = ⌊2^CAND_BITS / q⌋`。
3. **阶段 2（并行规约与判断）**：对每个 LANE 的候选值并行执行 Barrett 模约，计算阈值比较并生成采样接受/重试标志。
最终输出寄存器在第四个周期输出结果，因此在连续工作时可以每个周期输出一批新的采样值。

## 接口描述
| 端口 | 方向 | 位宽 | 说明 |
| ---- | ---- | ---- | ---- |
| `clk` | 输入 | 1 | 时钟输入。 |
| `rst_n` | 输入 | 1 | 低有效复位信号。 |
| `random_valid` | 输入 | 1 | 指示 `random_in` 与 `q` 的有效性。 |
| `random_in` | 输入 | `RANDOM_WIDTH` | 伪随机数流（默认 128 位）。 |
| `q` | 输入 | `Q_BITS` | 模数，采样输出范围为 `[0, q)`。 |
| `random_ready` | 输出 | 1 | 恒为高电平，表示模块随时可以接受新的随机数。 |
| `sampled_vals` | 输出 | `LANES*CAND_BITS` | 并行输出的采样结果。 |
| `sampled_valid` | 输出 | `LANES` | 每个 LANE 的采样有效标志。 |
| `retry_mask` | 输出 | `LANES` | 每个 LANE 需要重新采样的标志。 |

### 关键参数
- `LANES`：并行 LANE 数目，默认 8。
- `CAND_BITS`：每个候选样本的位宽，默认 16。
- `Q_BITS`：模数 `q` 的位宽，默认 16。
- `RANDOM_WIDTH`：输入随机数总位宽，可根据 PRNG 输出调整，默认 128。

`LANES*CAND_BITS` 必须不大于 `RANDOM_WIDTH`，否则综合时会报错。

## 核心算法说明
- **Barrett 模约**：计算 `t = ((value * mu) >> BARRETT_WIDTH)`，随后执行 `value - t*q` 并进行一次补偿减法，避免硬件除法器。
- **拒绝采样阈值**：阈值 `threshold = q * floor`，其中 `floor = ⌊2^CAND_BITS / q⌋`。当候选值小于阈值时接受采样，否则输出重试标志。
- **并行化**：所有 LANE 在组合逻辑内并行处理，流水线结构保证高频率运行。

## 仿真与验证
1. **生成激励与黄金模型**：在仓库根目录执行
   ```bash
   python3 4.UNIFORM/test/uniform_sampler_model.py
   ```
   该脚本会重新生成 `test/data` 下的激励与期望结果，并使用软件黄金模型验证逻辑。
2. **运行 iverilog 仿真**：
   ```bash
   iverilog -o 4.UNIFORM/test/uniform_sampler_tb.vvp 4.UNIFORM/uniform_sampler.v 4.UNIFORM/test/uniform_sampler_tb.v
   vvp 4.UNIFORM/test/uniform_sampler_tb.vvp
   ```
   仿真应输出 `Test completed successfully.`。

## 集成建议
- 若外部 PRNG 输出位宽大于 128 位，可通过参数 `RANDOM_WIDTH` 调整输入宽度，并确保提供足够的随机比特。
- `sampled_valid` 与 `retry_mask` 可用于后续的缓冲或重新请求逻辑。当某一 LANE 置位 `retry_mask` 时，应提供新的随机数并重新采样。
- 模块内部无复杂除法器，关键路径由乘法器和加法器组成，建议配合综合工具进行时序优化以达到 150 MHz 以上工作频率。
