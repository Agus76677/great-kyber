# Kyber NTT/INTT 模块代码说明

## 模块概述
本目录实现了面向 Kyber 后量子密码算法的 256 点 Number Theoretic Transform（NTT）与逆变换（INTT）硬件模块。设计采用 Radix-2 蝶形结构，并结合多阶段流水线，在 FPGA/ASIC 中完成多项式域上的快速乘法与还原运算。每个蝶形单元的模运算通过 Barrett Reduction 加速，避免硬件除法器，提升了吞吐率与时序裕量。

核心文件如下：

- `kyber_ntt.v`：实现顺变换 NTT，输入 256 个系数（16 bit/系数），输出频域系数。内部通过 8 个阶段的 Radix-2 蝶形迭代，配合常数 ROM 完成 twiddle 因子访问。
- `kyber_intt.v`：实现逆变换 INTT。使用 Gentleman-Sande 结构执行蝶形合并，完毕后对所有系数乘以 `256^{-1} mod q` 以恢复时域表示。
- `zetas_rom.v`：包含正向/逆向 twiddle 因子 ROM，各存储 255 个常量，与 Python 黄金模型保持一致。
- `kyber_params.vh` & `kyber_mod_functions.vh`：定义 Kyber 模数参数与模加、模减、Barrett 函数。
- `test/ntt_tb.v`、`test/intt_tb.v`：NTT/INTT 独立功能仿真 testbench。
- `test/run_tests.py`：黄金模型与仿真驱动脚本，自动完成测试向量生成、仿真、结果比对与卡方统计。

## 数据接口
两个模块共享统一接口：

- `data_in[127:0]`：一次加载 8 个 16 位系数，`valid_in`/`ready_in` 完成握手。
- `data_out[127:0]`：一次输出 8 个系数，伴随 `valid_out` 有效。
- `start`：启动一次变换，`done` 在全部输出完成后置位 1 个时钟。
- 复位信号 `reset` 为同步复位。

## 流水线结构
在蝶形运算阶段采用两拍流水：

1. **Phase 0**：根据 `len_size`、`block_base` 与 `position` 计算读地址，锁存两个输入系数和 twiddle 因子。
2. **Phase 1**：执行乘法与 Barrett 模约简，更新蝶形输出并进入下一对数据。

对于 INTT，在所有阶段结束后进入 `S_SCALE`，串行乘以 `n^{-1}` 完成归一化。

## Barrett 模约简
`barrett_reduce` 函数使用常量 `v = ⌊(2^{26} + q/2)/q⌋ = 20159`：

1. 计算 `prod = value * v`，
2. 右移 26 位获得近似商 `t`，
3. 执行 `value - t*q`，并通过加减 `q` 的方式消除负值和过剩部分。

所有加减操作均在 17 bit/33 bit 范围内完成，保证可综合性与时序安全。

## 测试说明
1. 确保已安装 Icarus Verilog（`iverilog`）。
2. 运行 Python 驱动脚本：
   ```bash
   ./5.NTT/test/run_tests.py
   ```
   脚本会执行三组随机多项式：
   - 对 NTT/INTT 输出与 Python 黄金模型逐项比较；
   - 统计输入分布的卡方指标，方便观察随机性；
   - 全部通过后打印 “All NTT/INTT hardware checks passed.”。

仿真生成的中间文件位于 `5.NTT/test` 及 `5.NTT/test/build` 下，可用于进一步波形分析。

## 时序与资源建议
- 蝶形阶段严格遵循 Radix-2 流水结构，乘法与 Barrett 函数在单周期完成，满足 150 MHz 以上的频率需求。
- Twiddle 因子存于查找表 ROM，可映射到 FPGA BRAM/ROM，实现资源与时序的平衡。

以上即为 NTT/INTT 模块的实现与使用说明。
